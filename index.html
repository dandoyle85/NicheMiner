
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auto Niche Miner Pro ‚Äî Phase 4 (Automation + Goal Optimizer)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0e1117;--panel:#131a24;--line:#22344d;--muted:#9bb0c5;--text:#e8eef7;--accent:#4ea3ff;--good:#2e7d32;--warn:#f9a825;--hot:#ff7043;--cool:#90a4ae;--rise:#66bb6a}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{background:#0b1018;border-bottom:1px solid var(--line);padding:12px}
  h1{margin:0;font-size:18px} .sub{font-size:13px;color:var(--muted)}
  .wrap{max-width:1260px;margin:0 auto;padding:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px 10px;border-bottom:1px solid #1c2535;text-align:left}
  th{background:#0e1420;color:#a7b4c7;font-size:11px;text-transform:uppercase}
  tr.clickable{cursor:pointer}
  .progress{background:#1b2332;border:1px solid var(--line);border-radius:999px;overflow:hidden;height:16px;min-width:240px}
  .bar{height:100%;width:0%;background:var(--warn)}
  .status-hot{color:var(--hot);font-weight:600}
  .status-rising{color:var(--rise)}
  .status-cooling{color:var(--cool)}
  /* Slide-in panel (Phase 3 reuse) */
  #sitePanel{position:fixed;top:0;right:-34%;height:100%;width:34%;background:#0b1018;border-left:1px solid var(--line);box-shadow:-10px 0 30px rgba(0,0,0,.25);transition:right .3s ease;z-index:40}
  #sitePanel.open{right:0}
  #sitePanel .pad{padding:14px;overflow:auto;height:100%}
  #panelClose{position:absolute;top:8px;right:10px;background:transparent;color:#cfe1ff;border:none;font-size:18px;cursor:pointer}
  .field{margin:10px 0}
  .toggle{display:flex;gap:10px;align-items:center}
  input[type=range]{width:100%}
  .mini-card{background:#0f1623;border:1px solid var(--line);border-radius:10px;padding:10px;margin:8px 0}
  /* AI Overview */
  #aiOverviewBtn{position:fixed;right:14px;bottom:14px;background:#0e2b52;color:#cfe1ff;border:1px solid #275b9a;border-radius:999px;padding:10px 14px;cursor:pointer;z-index:30}
  #aiModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;padding:40px;z-index:60}
  #aiModal.open{display:flex}
  #aiModal .sheet{background:#0b1018;border:1px solid var(--line);border-radius:12px;max-width:980px;width:100%;max-height:80vh;overflow:auto;padding:16px;position:relative}
  #aiModal .close{position:absolute;top:8px;right:10px;background:transparent;color:#cfe1ff;border:none;font-size:18px;cursor:pointer}
  .ai-card{border:1px solid var(--line);border-radius:10px;padding:12px;margin:10px 0;background:#0f1623}
  .ai-card h4{margin:0 0 6px 0}
  .btn{padding:8px 10px;border:none;border-radius:8px;cursor:pointer}
  .btn-apply{background:#2e7d32;color:#fff}
  .btn-secondary{background:#22344d;color:#cfe1ff}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  /* Automation modal */
  #autoBtn{position:fixed;left:14px;bottom:14px;background:#174026;color:#e8ffe9;border:1px solid #2c7a3f;border-radius:999px;padding:10px 14px;cursor:pointer;z-index:30}
  #autoModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;padding:40px;z-index:60}
  #autoModal.open{display:flex}
  #autoModal .sheet{background:#0b1018;border:1px solid var(--line);border-radius:12px;max-width:760px;width:100%;max-height:80vh;overflow:auto;padding:16px;position:relative}
  #autoModal .close{position:absolute;top:8px;right:10px;background:transparent;color:#cfe1ff;border:none;font-size:18px;cursor:pointer}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#22344d;color:#cfe1ff;border:1px solid #2f4c70;border-radius:8px;padding:8px 12px;opacity:0;transition:opacity .25s ease}
  .toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <h1>üß≠ Auto Niche Miner Pro ‚Äî Phase 4</h1>
  <div class="sub">Automation toggles ‚Ä¢ Goal-based aggression optimizer ‚Ä¢ Empire & site AI</div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <h3 style="margin:0">üèÜ Empire Leaderboard</h3>
      <div style="margin-left:auto">
        <label for="siteSelect" class="sub">Quick select:</label>
        <select id="siteSelect"></select>
      </div>
    </div>
    <table id="leaderboard"><thead><tr><th>Site</th><th>Daily Rev</th><th>Status</th></tr></thead><tbody></tbody></table>
  </section>

  <section class="card">
    <h3>üí∞ Empire Revenue Goal</h3>
    <div class="row">
      <div class="progress" style="flex:1;min-width:200px"><div id="empireBar" class="bar"></div></div>
      <input id="goalInput" type="number" min="0" value="2000" style="width:120px;padding:6px;border-radius:8px;border:1px solid var(--line);background:#0e1420;color:#cfe1ff">
      <button class="btn btn-secondary" id="applyGoalBtn">Set Goal</button>
      <label class="sub" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="autoAgg"> Auto Aggression</label>
      <button class="btn btn-apply" id="runOptimizerBtn">Run Optimizer</button>
    </div>
    <p id="empireRevText">$0 / $2000 (0%)</p>
  </section>

  <section class="card">
    <h3>üåê Empire Traffic (30d)</h3>
    <canvas id="empireChart" height="120"></canvas>
  </section>
</main>

<!-- Slide-in Site Panel (from Phase 3) -->
<aside id="sitePanel">
  <button id="panelClose">‚úñ</button>
  <div class="pad">
    <h3 id="panelTitle">Site Details</h3>
    <div class="mini-card">
      <strong>Summary</strong>
      <div id="siteSummary" class="sub">‚Äî</div>
    </div>
    <div class="mini-card">
      <strong>30d Traffic</strong>
      <canvas id="siteChart" height="90"></canvas>
    </div>
    <div class="mini-card">
      <strong>Settings</strong>
      <div class="field">Aggression: <span id="aggVal">1</span>
        <input id="aggSlider" type="range" min="1" max="10" value="1"/>
      </div>
      <div class="field toggle"><input type="checkbox" id="autoBlog"> <label for="autoBlog">Auto-blog</label></div>
      <div class="field toggle"><input type="checkbox" id="autoPins"> <label for="autoPins">Auto-pins</label></div>
      <div class="field toggle"><input type="checkbox" id="autoShorts"> <label for="autoShorts">Auto-shorts</label></div>
      <button class="btn btn-secondary" id="saveSettingsBtn">üíæ Save Settings</button>
    </div>
    <div class="mini-card">
      <strong>AI Coach (this site)</strong>
      <div id="siteCoachText" class="sub">‚Äî</div>
      <button class="btn btn-apply" id="siteApplyBtn">‚úÖ Apply This</button>
    </div>
  </div>
</aside>

<!-- AI Overview & Automation Buttons -->
<button id="aiOverviewBtn">‚ö° AI Overview</button>
<button id="autoBtn">ü§ñ Automation</button>

<!-- Full-screen AI Overview Modal -->
<div id="aiModal">
  <div class="sheet">
    <button class="close" id="aiClose">‚úñ</button>
    <h3>‚ö° AI Overview ‚Äî Recommendations</h3>
    <div id="aiCards"></div>
    <div style="text-align:right;margin-top:10px">
      <button class="btn btn-apply" id="applyAllBtn">‚úÖ Apply All</button>
    </div>
  </div>
</div>

<!-- Automation Modal -->
<div id="autoModal">
  <div class="sheet">
    <button class="close" id="autoClose">‚úñ</button>
    <h3>ü§ñ Automation Engine (Demo)</h3>
    <p class="sub">This simulates a scheduled run. It will apply effects to sites with toggles enabled.</p>
    <ul class="sub">
      <li><strong>Auto-blog:</strong> + (aggression √ó 3) revenue, +2 traffic/day</li>
      <li><strong>Auto-pins:</strong> + (aggression √ó 2) revenue, +3 traffic/day</li>
      <li><strong>Auto-shorts:</strong> + (aggression √ó 4) revenue, +4 traffic/day</li>
    </ul>
    <button class="btn btn-apply" id="runAutomationNow">Run Automation Now</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { getSites, upsertSite, getSettings, updateSettings } from './supabase-client.js';

  let SITES = [];
  let SETTINGS = {}; // cache by siteId
  let EMPIRE_GOAL = 2000;
  let chartEmpire = null;
  let chartSite = null;
  let currentSite = null;
  let currentSettings = null;

  // ---------- Init ----------
  async function init() {
    SITES = await getSites();
    renderAll();
    bindUI();
    toggleFloatingButtons();
  }

  function renderAll(){
    renderLeaderboard();
    renderEmpireStats();
    renderEmpireChart();
    buildDropdown();
  }

  // ---------- Renderers ----------
  function renderLeaderboard() {
    const tbody = document.querySelector("#leaderboard tbody");
    tbody.innerHTML = "";
    SITES.sort((a,b)=> (b.revenue||0) - (a.revenue||0));
    SITES.forEach(site => {
      const tr = document.createElement("tr");
      tr.className = "clickable";
      tr.onclick = () => openSitePanel(site.id);
      const st = statusClass(site.status);
      tr.innerHTML = \`
        <td>\${site.name}</td>
        <td>$\${site.revenue||0}</td>
        <td class="\${st.cls}">\${st.text}</td>
      \`;
      tbody.appendChild(tr);
    });
  }

  function renderEmpireStats() {
    const total = SITES.reduce((s,x)=>s+(x.revenue||0),0);
    const pct = Math.round(total/EMPIRE_GOAL*100);
    document.getElementById("empireBar").style.width = pct+"%";
    document.getElementById("empireRevText").textContent = "$"+total+" / $"+EMPIRE_GOAL+" ("+pct+"%)";
    document.getElementById("goalInput").value = EMPIRE_GOAL;
  }

  function renderEmpireChart() {
    const ctx = document.getElementById("empireChart").getContext("2d");
    const labels = ["D-5","D-4","D-3","D-2","D-1","D-0"];
    const datasets = SITES.map((s, i)=>({
      label: s.name,
      data: s.traffic || [],
      borderColor: ["#4ea3ff","#c08cff","#4cd964","#ffcc66","#66cccc"][i%5],
      tension: .25
    }));
    if (chartEmpire) chartEmpire.destroy();
    chartEmpire = new Chart(ctx,{type:"line",data:{labels,datasets},options:{plugins:{legend:{labels:{color:"#cfe1ff"}}},scales:{x:{ticks:{color:"#9bb0c5"}},y:{ticks:{color:"#9bb0c5"}}}}});
  }

  function statusClass(status){
    if((status||'').toLowerCase()==='hot') return {text:"üî• Hot", cls:"status-hot"};
    if((status||'').toLowerCase()==='rising') return {text:"üöÄ Rising", cls:"status-rising"};
    return {text:"‚ùÑÔ∏è Cooling", cls:"status-cooling"};
  }

  // ---------- Dropdown ----------
  function buildDropdown(){
    const sel = document.getElementById("siteSelect");
    sel.innerHTML = "";
    SITES.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id; opt.textContent = s.name;
      sel.appendChild(opt);
    });
    sel.onchange = ()=> openSitePanel(parseInt(sel.value));
  }

  // ---------- Slide-in Panel ----------
  async function openSitePanel(siteId){
    currentSite = SITES.find(s=>s.id===siteId);
    if(!currentSite) return;
    document.getElementById("panelTitle").textContent = currentSite.name;
    document.getElementById("siteSummary").textContent = "Revenue $"+(currentSite.revenue||0)+" ‚Ä¢ Status "+(currentSite.status||'-');

    // site mini chart
    const ctx = document.getElementById("siteChart").getContext("2d");
    const labels = ["D-5","D-4","D-3","D-2","D-1","D-0"];
    if(chartSite) chartSite.destroy();
    chartSite = new Chart(ctx,{type:"line",data:{labels,datasets:[{label:currentSite.name,data:currentSite.traffic||[],borderColor:"#4ea3ff",tension:.25}]},options:{plugins:{legend:{labels:{color:"#cfe1ff"}}},scales:{x:{ticks:{color:"#9bb0c5"}},y:{ticks:{color:"#9bb0c5"}}}}});

    // settings
    currentSettings = await getSettings(currentSite.id) || { aggression: 3, auto_blog:false, auto_pins:false, auto_shorts:false };
    SETTINGS[currentSite.id] = currentSettings;
    document.getElementById("aggSlider").value = currentSettings.aggression || 1;
    document.getElementById("aggVal").textContent = currentSettings.aggression || 1;
    document.getElementById("autoBlog").checked = !!currentSettings.auto_blog;
    document.getElementById("autoPins").checked = !!currentSettings.auto_pins;
    document.getElementById("autoShorts").checked = !!currentSettings.auto_shorts;

    // site coach text
    document.getElementById("siteCoachText").textContent = siteCoachRecommendation(currentSite, currentSettings);

    document.getElementById("sitePanel").classList.add("open");
    toggleFloatingButtons();
  }

  document.getElementById("panelClose").onclick = ()=>{
    document.getElementById("sitePanel").classList.remove("open");
    currentSite = null;
    toggleFloatingButtons();
  };

  document.getElementById("aggSlider").oninput = (e)=>{
    document.getElementById("aggVal").textContent = e.target.value;
  };

  document.getElementById("saveSettingsBtn").onclick = async ()=>{
    if(!currentSite) return;
    const values = {
      aggression: parseInt(document.getElementById("aggSlider").value),
      auto_blog: document.getElementById("autoBlog").checked,
      auto_pins: document.getElementById("autoPins").checked,
      auto_shorts: document.getElementById("autoShorts").checked
    };
    await updateSettings(currentSite.id, values);
    SETTINGS[currentSite.id] = values;
    toast("Settings saved.");
  };

  document.getElementById("siteApplyBtn").onclick = async ()=>{
    if(!currentSite) return;
    const ag = (SETTINGS[currentSite.id]?.aggression)||3;
    const revBoost = 10 + ag * 4;
    currentSite.revenue = (currentSite.revenue||0) + revBoost;
    currentSite.status = "Rising";
    currentSite.traffic = (currentSite.traffic||[]).map(v=> v + Math.ceil(ag/2));
    await upsertSite(currentSite);
    SITES = await getSites();
    renderAll();
    toast("Applied on "+currentSite.name+" (+"+revBoost+")");
  };

  // ---------- AI Overview (unchanged logic) ----------
  document.getElementById("aiOverviewBtn").onclick = ()=> openAiModal();
  document.getElementById("aiClose").onclick = ()=> document.getElementById("aiModal").classList.remove("open");

  async function openAiModal(){
    const container = document.getElementById("aiCards");
    container.innerHTML = "";
    for (const s of SITES){
      const st = statusClass(s.status);
      const rec = overviewRecommendation(s);
      const card = document.createElement("div");
      card.className = "ai-card";
      card.innerHTML = \`
        <h4>\${s.name}</h4>
        <div class="sub">Status: <span class="\${st.cls}">\${st.text}</span></div>
        <div style="margin:6px 0 10px 0">\${rec.text}</div>
        <button class="btn btn-apply">Apply This</button>
      \`;
      card.querySelector("button").onclick = async ()=>{
        await applyOverviewAction(s, rec);
        await postApplyRefresh();
      };
      container.appendChild(card);
    }
    document.getElementById("aiModal").classList.add("open");
  }

  document.getElementById("applyAllBtn").onclick = async ()=>{
    for (const s of SITES){
      const rec = overviewRecommendation(s);
      await applyOverviewAction(s, rec);
    }
    await postApplyRefresh();
  };

  async function postApplyRefresh(){
    SITES = await getSites();
    renderAll();
    document.getElementById("aiModal").classList.remove("open");
    toast("AI actions applied.");
  }

  function overviewRecommendation(site){
    if ((site.status||'').toLowerCase()==='cooling'){
      return { text: "Cooling ‚Üí +30 revenue, +2/day traffic, mark Rising.", rev:30, traf:2, newStatus:"Rising", setPins:false };
    }
    if (site.revenue>500){
      return { text: "Hot ‚Üí enable Auto-Pins; +10 revenue, +1/day traffic.", rev:10, traf:1, newStatus:"Hot", setPins:true };
    }
    return { text: "Rising ‚Üí steady +20 revenue, +1/day traffic.", rev:20, traf:1, newStatus:"Rising", setPins:false };
  }

  async function applyOverviewAction(site, rec){
    site.revenue = (site.revenue||0) + rec.rev;
    site.traffic = (site.traffic||[]).map(v=> v + rec.traf);
    site.status = rec.newStatus;
    await upsertSite(site);
    if (rec.setPins){
      await updateSettings(site.id, { auto_pins: true });
      SETTINGS[site.id] = { ...(SETTINGS[site.id]||{}), auto_pins:true };
    }
  }

  // ---------- Automation Modal ----------
  document.getElementById("autoBtn").onclick = ()=> document.getElementById("autoModal").classList.add("open");
  document.getElementById("autoClose").onclick = ()=> document.getElementById("autoModal").classList.remove("open");

  document.getElementById("runAutomationNow").onclick = async ()=>{
    // Simulate a scheduled run
    for (const s of SITES){
      const set = SETTINGS[s.id] || await getSettings(s.id) || {aggression:3, auto_blog:false, auto_pins:false, auto_shorts:false};
      SETTINGS[s.id] = set;
      let boost = 0, traf = 0;
      if (set.auto_blog){ boost += set.aggression*3; traf += 2; }
      if (set.auto_pins){ boost += set.aggression*2; traf += 3; }
      if (set.auto_shorts){ boost += set.aggression*4; traf += 4; }
      if (boost>0 || traf>0){
        s.revenue = (s.revenue||0) + boost;
        s.traffic = (s.traffic||[]).map(v=> v + traf);
        s.status = "Rising";
        await upsertSite(s);
      }
    }
    SITES = await getSites();
    renderAll();
    document.getElementById("autoModal").classList.remove("open");
    toast("Automation run complete.");
  };

  // ---------- Goal-based Aggression Optimizer ----------
  document.getElementById("applyGoalBtn").onclick = ()=>{
    const v = parseInt(document.getElementById("goalInput").value)||2000;
    EMPIRE_GOAL = v;
    renderEmpireStats();
    toast("Goal set to $"+EMPIRE_GOAL);
  };

  document.getElementById("runOptimizerBtn").onclick = async ()=>{
    const total = SITES.reduce((s,x)=>s+(x.revenue||0),0);
    const deficit = Math.max(0, EMPIRE_GOAL - total);
    if (deficit===0){ toast("Goal already met."); return; }
    // Simple split: bias hotter sites slightly
    const sumRev = SITES.reduce((s,x)=>s+(x.revenue||0),0)||1;
    for (const s of SITES){
      const share = (s.revenue||0)/sumRev; // higher share ‚Üí higher aggression
      const targetAgg = Math.min(10, Math.max(3, Math.round(4 + share*6)));
      await updateSettings(s.id, { aggression: targetAgg });
      SETTINGS[s.id] = { ...(SETTINGS[s.id]||{}), aggression: targetAgg };
    }
    toast("Optimizer set aggression per site to help reach goal.");
  };

  document.getElementById("autoAgg").onchange = (e)=>{
    if (e.target.checked){
      toast("Auto Aggression ON ‚Äî run optimizer periodically.");
    } else {
      toast("Auto Aggression OFF.");
    }
  };

  // ---------- Utils ----------
  function toggleFloatingButtons(){
    const open = document.getElementById("sitePanel").classList.contains("open");
    document.getElementById("aiOverviewBtn").style.display = open ? "none":"block";
    document.getElementById("autoBtn").style.display = open ? "none":"block";
  }

  function toast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=> t.classList.remove("show"), 1800);
  }

  init();
</script>
</body>
</html>
