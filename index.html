<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Niche Miner Pro ‚Äî Phase 2 (AI Coach)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{margin:0;background:#0e1117;color:#e8eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    header{background:#0b1018;border-bottom:1px solid #22344d;padding:12px}
    h1{margin:0;font-size:18px} .sub{font-size:13px;color:#9bb0c5}
    .wrap{max-width:1260px;margin:0 auto;padding:12px}
    .card{background:#131a24;border:1px solid #22344d;border-radius:12px;padding:12px;margin-top:12px}
    .progress{background:#1b2332;border:1px solid #22344d;border-radius:999px;overflow:hidden;height:16px;min-width:240px}
    .bar{height:100%;width:0%;background:#2e7d32}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid #1c2535;text-align:left}
    th{background:#0e1420;color:#a7b4c7;font-size:11px;text-transform:uppercase}
    #coach{position:fixed;bottom:0;right:0;width:300px;background:#1c2535;border-top-left-radius:10px;border:1px solid #2a3a50;display:none;flex-direction:column}
    #coach header{background:#24344d;color:#fff;padding:8px;font-size:14px;cursor:pointer}
    #coach .body{padding:10px;font-size:13px;color:#cfe1ff}
    #coach button{margin-top:10px;padding:6px 10px;background:#2e7d32;color:#fff;border:none;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
<header>
  <h1>üß≠ Auto Niche Miner Pro ‚Äî Phase 2</h1>
  <div class="sub">AI Coach + Apply button wired to Supabase</div>
</header>

<main class="wrap">
  <section class="card">
    <h3>üèÜ Empire Leaderboard</h3>
    <table id="leaderboard"><thead><tr><th>Site</th><th>Daily Rev</th><th>Status</th></tr></thead><tbody></tbody></table>
  </section>

  <section class="card">
    <h3>üí∞ Empire Revenue Goal</h3>
    <div class="progress"><div id="empireBar" class="bar"></div></div>
    <p id="empireRevText">$0 / $2000 (0%)</p>
  </section>

  <section class="card">
    <h3>üåê Empire Traffic (30d)</h3>
    <canvas id="empireChart" height="120"></canvas>
  </section>

  <section class="card">
    <h3>üîΩ Select Site</h3>
    <select id="siteSelect"></select>
  </section>
</main>

<div id="coach">
  <header onclick="toggleCoach()">üí° AI Coach (click to toggle)</header>
  <div class="body">
    <p id="coachText">Loading...</p>
    <button id="applyBtn">‚úÖ Apply This</button>
  </div>
</div>

<script type="module">
  import { getSites, upsertSite } from './supabase-client.js';

  let currentSites = [];
  let selectedSite = null;

  async function initDashboard() {
    currentSites = await getSites();
    buildLeaderboard(currentSites);
    buildEmpireStats(currentSites);
    buildTrafficChart(currentSites);
    buildDropdown(currentSites);
    pickCoachRecommendation(currentSites);
  }

  function buildLeaderboard(sites) {
    const tbody=document.querySelector("#leaderboard tbody");
    tbody.innerHTML="";
    sites.forEach(site=>{
      const tr=document.createElement("tr");
      const td1=document.createElement("td"); td1.textContent=site.name;
      const td2=document.createElement("td"); td2.textContent="$"+site.revenue;
      const td3=document.createElement("td"); td3.textContent=site.status;
      tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);
      tbody.appendChild(tr);
    });
  }

  function buildEmpireStats(sites) {
    let empireTotal=sites.reduce((sum,s)=>sum+(s.revenue||0),0);
    let goal=2000; let pct=Math.round(empireTotal/goal*100);
    document.getElementById("empireBar").style.width=pct+"%";
    document.getElementById("empireRevText").textContent="$"+empireTotal+" / $"+goal+" ("+pct+"%)";
  }

  function buildTrafficChart(sites) {
    const ctx=document.getElementById("empireChart").getContext("2d");
    new Chart(ctx,{
      type:"line",
      data:{
        labels:["D-5","D-4","D-3","D-2","D-1","D-0"],
        datasets:sites.map((site,idx)=>({
          label:site.name,
          data:site.traffic||[],
          borderColor:["#4ea3ff","#c08cff","#4cd964"][idx%3],
          tension:.25
        }))
      },
      options:{plugins:{legend:{labels:{color:"#cfe1ff"}}},scales:{x:{ticks:{color:"#9bb0c5"}},y:{ticks:{color:"#9bb0c5"}}}}
    });
  }

  function buildDropdown(sites) {
    const sel=document.getElementById("siteSelect");
    sel.innerHTML="";
    sites.forEach(site=>{
      let opt=document.createElement("option");
      opt.value=site.id;
      opt.textContent=site.name;
      sel.appendChild(opt);
    });
    sel.addEventListener("change",()=>{
      let id=parseInt(sel.value);
      selectedSite=currentSites.find(s=>s.id===id);
      document.getElementById("coachText").textContent = "AI ready for " + selectedSite.name;
    });
    if (sites.length>0){ sel.value=sites[0].id; selectedSite=sites[0]; }
  }

  function pickCoachRecommendation(sites){
    // Pick coldest site
    let target=sites.find(s=>s.status==="Cooling")||sites[0];
    document.getElementById("coachText").textContent = "Your site "+target.name+" is Cooling. Recommend +30 revenue, +2 traffic, mark as Rising.";
    document.getElementById("coach").style.display="flex";
  }

  document.getElementById("applyBtn").addEventListener("click",async()=>{
    if (!selectedSite) return;
    selectedSite.revenue=selectedSite.revenue+30;
    selectedSite.status="Rising";
    selectedSite.traffic=(selectedSite.traffic||[]).map(v=>v+2);
    await upsertSite(selectedSite);
    currentSites=await getSites();
    buildLeaderboard(currentSites);
    buildEmpireStats(currentSites);
    buildTrafficChart(currentSites);
    alert("AI Coach applied changes to "+selectedSite.name);
  });

  window.toggleCoach=function(){
    const el=document.getElementById("coach");
    if(el.style.height==="30px"){ el.style.height="auto"; } else { el.style.height="30px"; }
  }

  initDashboard();
</script>
</body>
</html>
